# FairDICE (Reproduction)

This codebase reproduces serves to reproduce the FairDICE results for offline multi-objective RL, specifically results pertaining to the Four Room environment setting. It adds the MO-Four-Room environment, visualization scripts, goal-mix sweeps and other utilities used in the reproduction study.

## Contents

### Core training and evaluation
- `main.py`: Main training/evaluation for MuJoCo/D4MORL tasks, not used for the discrete Four Room setting.
- `main_fourroom.py`: Training/evaluation entrypoint for the FourRoom environment.
- `FairDICE.py`: FairDICE model, training step, and checkpoint I/O for continuous-control tasks.
- `evaluation.py`: Policy evaluation utilities (NSW, utility metrics, episode rollouts).
- `buffer.py`: Offline dataset buffer and sampling utilities.
- `utils.py`: Normalization and helper functions.

### Environments and data
- `environments/`: Custom and wrapped environments.
  - `MO-Four-Room.py`, `MO-Four-Room-gymnasium.py`, `MO-Nine-Room.py`: discrete X-Room environment definitions.
- `data/`: Offline datasets (generated FourRoom datasets).

### Job files (SLURM)
- `job-files/four-room-train.job`: Single FourRoom training run (FairDICE).
- `job-files/four-room-goalmix-sweep.job`: Goal-mix sweep for FourRoom.
- `job-files/four-room-sweep-and-vis.job`: Sweep + optional visualization pipeline.
- `job-files/four-room-visualize.job`: Visualize a trained FourRoom policy.
- `job-files/four-room-eval-welfare.job`: Evaluate NSW and aggregate results.

### Utility scripts
- `utility-scripts/train_fairdice_single_with_cc.py`: Run a single training job under CodeCarbon.
- `utility-scripts/evaluate_sweep_welfare.py`: Evaluate a sweep and write a CSV of metrics.
- `utility-scripts/merge_goalmix_nsw.py`: Merge sweep CSV with goal reach ratios.
- `utility-scripts/plot_goalmix_ternary.py`: Plot a ternary NSW vs reach ratios figure.
- `utility-scripts/compute_objective_reach.py`: Compute goal reach stats from datasets.
- `utility-scripts/generate_fourroom_data.py`: Generate FourRoom offline datasets.

### Results and logs
- `results/`: Checkpoints and sweep outputs.
- `logs/`: SLURM outputs and CodeCarbon logs.

## Setup

Create the environment:
```
conda env create -f environment.yml
conda activate fairdice
```

If on Snellius, load Anaconda before activating:
```
module purge
module load 2025
module load Anaconda3/2025.06-1
conda activate fairdice
```

## Data

### FourRoom
FourRoom datasets should be generated by `main_fourroom.py` if missing. You can also
generate explicitly:
```
python utility-scripts/generate_fourroom_data.py \
  --env_name MO-FourRoom-v2 \
  --num_trajectories 300 \
```

## How to run

### 1) Single FourRoom training
```
python main_fourroom.py \
  --learner FairDICE \
  --divergence CHI \
  --env_name MO-FourRoom-v2 \
  --quality amateur \
  --beta 0.001 \
  --seed 1984 \
  --preference_dist uniform \
  --eval_episodes 10 \
  --batch_size 64 \
  --hidden_dim 256 \
  --num_layers 2 \
  --total_train_steps 100000 \
  --log_interval 1000 \
  --normalize_reward False \
  --max_seq_len 400 \
  --policy_lr 3e-4 \
  --nu_lr 3e-4 \
  --mu_lr 3e-4 \
  --gamma 0.99 \
  --save_model_mode last
```

### 2) Track emissions for a single run with CodeCarbon
```
python utility-scripts/train_fairdice_single_with_cc.py
```
This uses FourRoom defaults (see script) and writes to `logs/codecarbon/fairdice_runs_.csv`.

### 3) FourRoom goal-mix sweep (assuming Snellius)
```
sbatch job-files/four-room-goalmix-sweep.job
```
Outputs go to `results/goalmix_sweep_<timestamp>/`.

### 4) Evaluate sweep + plot ternary
From the sweep output directory:
```
python utility-scripts/evaluate_sweep_welfare.py \
  --results_dir results/goalmix_sweep_YYYYMMDD_HHMMSS \
  --episodes 100 \
  --group_by mix
```

Merge with reach ratios and plot:
```
python utility-scripts/merge_goalmix_nsw.py \
  --csv results/goalmix_sweep_YYYYMMDD_HHMMSS/reeval_welfare_episodes_100.csv

python utility-scripts/plot_goalmix_ternary.py \
  --csv results/goalmix_sweep_YYYYMMDD_HHMMSS/reeval_welfare_episodes_100_with_reach.csv \
  --output results/goalmix_sweep_YYYYMMDD_HHMMSS/ternary_nsw.png
```

### 5) Visualize a trained FourRoom policy
```
python visualize_fourroom.py \
  --per_state_cap 1 \
  --max_steps 200 \
  --num_episodes 100 \
  --stochastic \
  --model_path /path/to/results/<run_dir>/model \
  --env_name MO-FourRoom-v2
```

## Notes on paths
- For SLURM jobs, the scripts assume `cd $HOME/claim4/fact-ai`, so use paths
  relative to that repo root.

## Reproducibility
- All default hyperparameters are documented in the job files and CLI commands above.
- Seeds: set `--seed` in `main_fourroom.py`.
- CodeCarbon logs: `logs/codecarbon/fairdice_runs_.csv`.
