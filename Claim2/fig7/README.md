# Fig7: MO-FourRoom Perturbation Grid (FairDICE-fixed)

This folder contains the full pipeline to reproduce Figure 7 for the MO-FourRoom environment. The steps below describe how to:
1) generate the MO-FourRoom offline dataset (auto-generated if missing),
2) compute mu* per seed,
3) aggregate mu* across seeds,
4) run the perturbation grid (cell-by-cell),
5) aggregate cell outputs and create the final plot.

All commands below are written to be run from this directory:
`C:\Users\vladc\OneDrive\Escritorio\fact-ai\Claim2\fig7`

## Setup
Create the environment and install dependencies:
```
conda create -n factai python=3.10 -y
conda activate factai
pip install -r requirements.txt
```

## Data (auto-generated)
The scripts expect data at:
`data/<ENV>/<ENV>_50000_<quality>_<pref>.pkl`

For example:
`data/MO-FourRoom-v2/MO-FourRoom-v2_50000_amateur_uniform.pkl`

If the dataset is missing, it is automatically generated by
`utility-scripts/generate_fourroom_data.py` when you run the mu* or Figure 7 scripts.

## Step 1: Compute mu* per seed
This trains FairDICE and saves mu* for each seed under `results/mu_star/seed_<seed>/`.

### Option A: SLURM array (HPC)
```
sbatch run_mu_star_util_array.sh
```

### Option B: Local / single seed
```
python -u utility-scripts/compute_mu_star.py ^
  --seed 0 ^
  --env_name MO-FourRoom-v2 ^
  --quality amateur ^
  --preference_dist uniform ^
  --beta 0.01 ^
  --divergence CHI ^
  --total_train_steps 100000 ^
  --log_interval 1000 ^
  --eval_episodes 50 ^
  --save_dir results/mu_star
```

Expected outputs (per seed):
- `results/mu_star/seed_<seed>/mu_star.json`
- `results/mu_star/seed_<seed>/mu_star.npz`

## Step 2: Aggregate mu* across seeds
This produces `mu_star_avg.npz`, which is used by the grid runs.
```
python -u utility-scripts/aggregate_mu_star.py ^
  --parent_dir results/mu_star
```

Expected outputs:
- `results/mu_star/mu_star_avg.json`
- `results/mu_star/mu_star_avg.npz`

## Step 3: Run the perturbation grid
Each cell runs FairDICE-fixed with a perturbation of mu2 and mu3. The array job maps
`(seed, cell)` and writes per-cell outputs.

### Option A: SLURM array (HPC)
```
sbatch run_fig7_cells_seed_array.sh
```

Note: The SLURM script uses a fixed `cd /home/scur0132/claim2/fig7_bartek`. Update it if your path differs.

### Option B: Local / single cell
```
python -u utility-scripts/figure7_fourroom.py ^
  --seed 0 ^
  --mu_star_path results/mu_star/mu_star_avg.npz ^
  --save_dir results/fig7_cells/seed=0/cell=0 ^
  --grid_points 21 --grid_min -0.1 --grid_max 0.1 ^
  --cell_index 0
```

Expected outputs (per cell):
- `cell_result.npz` under the cell directory

## Step 4: Aggregate cells and create the final plot
This scans all `cell_result.npz` files and builds the full grids + figure.
```
python -u utility-scripts/aggregate_figure7_cells.py ^
  --root_dir results/fig7_cells ^
  --grid_points 21 --grid_min -0.1 --grid_max 0.1 ^
  --output_npz fig7_data_aggregated.npz ^
  --output_fig fig7_aggregated.png
```

Expected outputs:
- `results/fig7_cells/fig7_data_aggregated.npz`
- `results/fig7_cells/fig7_aggregated.png`

## Notes
- If `results/mu_star/mu_star_avg.npz` is missing, re-run Steps 1â€“2.
- If aggregation fails, verify that cell outputs exist and were run with the same grid settings.

## License
This project is licensed under the MIT License.
